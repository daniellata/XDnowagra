<!DOCTYPE html>
<html>
<body>

<canvas id="gameCanvas" width="800" height="600" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>

<div id="score">Score: 0</div>
<div id="highScore">High Score: 0</div>
<div id="highScoreTime">High Score Time: 0</div>

<div>
    <label for="timerInput">Czas gry (minuty):</label>
    <input id="timerInput" type="number" min="1">
    <button id="startButton">Start z minutnikiem</button>
    <button id="startButtonNoTimer">Start bez minutnika</button>
</div>

<script>
// Inicjacja gry
var canvas = document.getElementById('gameCanvas');
var ctx = canvas.getContext('2d');

// Definicja gracza
var player;

// Definicja punktacji
var score;

// Definicja mapy
var map;

// Liczba niebieskich kwadratów
var blueSquareCount;

// Czy gra jest na czas
var isTimedGame = false;

// Czas gry
var gameTime;

// Szybkość gracza
var playerSpeed;
var defaultPlayerSpeed = 10;

// Najwyższy wynik i czas, w którym został uzyskany
fetch('http://localhost:3000/highscore')
    .then(response => response.json())
    .then(data => {
        document.getElementById('highScore').innerText = "High Score: " + data.score;
        document.getElementById('highScoreTime').innerText = "High Score Time: " + new Date(data.time).toLocaleString();
    });

// Funkcja dodająca losowe niebieskie kwadraty
function addBlueSquares() {
    blueSquareCount = Math.floor(Math.random() * 10) + 1; // 1 do 10
    for(var i = 0; i < blueSquareCount; i++) {
        var randX = Math.floor(Math.random() * 40);
        var randY = Math.floor(Math.random() * 30);
        map[randX][randY] = 2; // 2 reprezentuje niebieski kwadrat
    }
}

// Inicjalizacja gry
function initGame() {
    player = {
        x: 50,
        y: 50,
        size: 20,
    };
    
    score = 0;
    document.getElementById('score').innerText = "Score: " + score;

    map = [];
    for(var i = 0; i < 40; i++) {
        map[i] = [];
        for(var j = 0; j < 30; j++) {
            map[i][j] = 0;
        }
    }

    addBlueSquares();

    playerSpeed = defaultPlayerSpeed;
}

initGame();

// Sterowanie
window.addEventListener('keydown', function(e) {
    var key = e.keyCode;
    if(key === 37 && player.x >= playerSpeed) player.x -= playerSpeed; // Lewo
    if(key === 38 && player.y >= playerSpeed) player.y -= playerSpeed; // Góra
    if(key === 39 && player.x < canvas.width - player.size) player.x += playerSpeed; // Prawo
    if(key === 40 && player.y < canvas.height - player.size) player.y += playerSpeed; // Dół
    if(key === 32) { // Spacja, umieszczanie bloku
        e.preventDefault(); // Zapobiegaj domyślnej akcji spacji
    }
});

// Rysowanie gry
function drawGame() {
    // Czyszczenie ekranu
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Rysowanie mapy
    for(var i = 0; i < 40; i++) {
        for(var j = 0; j < 30; j++) {
            if(map[i][j] === 1) {
                ctx.fillStyle = "#000000";
                ctx.fillRect(i * 20, j * 20, 20, 20);
            } else if(map[i][j] === 2) {
                ctx.fillStyle = "#0000FF";
                ctx.fillRect(i * 20, j * 20, 20, 20);
            } else if(map[i][j] === 3) {
                ctx.fillStyle = "#00FF00";
                ctx.fillRect(i * 20, j * 20, 20, 20);
            }
        }
    }

    // Rysowanie gracza
    ctx.fillStyle = "#FF0000";
    ctx.fillRect(player.x, player.y, player.size, player.size);

    // Sprawdzanie, czy gracz zebrał niebieski kwadrat
    var gridX = Math.floor(player.x / 20);
    var gridY = Math.floor(player.y / 20);
    if(map[gridX][gridY] === 2) {
        map[gridX][gridY] = 0; // Usuń niebieski kwadrat
        score++; // Zwiększ punktację
        blueSquareCount--; // Zmniejsz liczbę niebieskich kwadratów
        document.getElementById('score').innerText = "Score: " + score; // Wyświetl punktację

        // Jeśli wszystkie niebieskie kwadraty zostały zebrane, dodaj nowe
        if(blueSquareCount === 0) {
            addBlueSquares();
        }
    }

    // Sprawdzanie, czy gracz zebrał zielony kwadrat
    if(map[gridX][gridY] === 3) {
        map[gridX][gridY] = 0; // Usuń zielony kwadrat
        playerSpeed += 5; // Zwiększ prędkość gracza
        setTimeout(function() {
            playerSpeed = defaultPlayerSpeed; // Resetuj prędkość gracza po 10 sekundach
        }, 10000);
    }
}

// Aktualizacja gry
var gameIsActive = false;
var animationId;
function updateGame() {
    if (gameIsActive) {
        drawGame();
        animationId = requestAnimationFrame(updateGame);
    } else {
        cancelAnimationFrame(animationId); // Zatrzymaj animację, gdy gra nie jest aktywna
    }
}

// Rozpoczęcie gry
document.getElementById('startButton').addEventListener('click', function() {
    isTimedGame = true;
    gameTime = document.getElementById('timerInput').value * 60; // Konwersja na sekundy
    gameIsActive = true;
    updateGame();
});

document.getElementById('startButtonNoTimer').addEventListener('click', function() {
    isTimedGame = false;
    gameIsActive = true;
    updateGame();
});

// Obsługa minutnika gry
setInterval(function() {
    if(isTimedGame && gameTime > 0) {
        gameTime--;
        if(gameTime === 0) {
            gameIsActive = false;
            // Tu można dodać logikę zakończenia gry
        }
    }
}, 1000);
</script>

</body>
</html>
